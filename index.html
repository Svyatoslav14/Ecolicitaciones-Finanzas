<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ecolicitaciones & Finanzas</title>
  <link rel="icon" href="logo.png" type="image/png" />
  <style>
    body { font-family: Arial, sans-serif; background: #f4f4f4; margin: 0; }
    header {
      background: #00695c; color: white; padding: 1em;
      display: flex; align-items: center;
    }
    header img { height: 60px; margin-right: 20px; }
    main {
      max-width: 1000px; margin: 2em auto; background: white;
      padding: 2em; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    label { display: block; margin-top: 1em; font-weight: bold; }
    input, select {
      width: 100%; padding: 10px; font-size: 1em;
      border: 1px solid #ccc; border-radius: 6px; margin-top: 0.3em;
    }
    button {
      background-color: #00796b; color: white;
      padding: 10px 20px; border: none;
      border-radius: 6px; font-size: 1em; margin-top: 1.5em;
      cursor: pointer;
    }
    button:hover { background-color: #004d40; }
    .oculto { display: none; }
    .resultados { margin-top: 2em; }
    .contrato { border-bottom: 1px solid #ccc; padding: 1em 0; }
  </style>
</head>
<body>

<header>
  <img src="logo.png" alt="Logo Ecolicitaciones">
  <h1>Ecolicitaciones & Finanzas</h1>
</header>

<main>
  <div id="formularioCliente">
    <h2>Datos del Cliente</h2>
    <label>Nombre</label>
    <input type="text" id="nombre" required>
    <label>Correo electrónico</label>
    <input type="email" id="correo" required>
    <label>Empresa</label>
    <input type="text" id="empresa">
    <label>Teléfono</label>
    <input type="text" id="telefono">
    <label><input type="checkbox" id="aceptaTerminos"> Acepto el tratamiento de mis datos personales</label>
    <button onclick="continuarFormulario()">Continuar</button>
  </div>

  <div id="formularioProceso" class="oculto">
    <h2>Selecciona el Proceso que deseas consultar</h2>
    <label for="tipoProceso">Tipo de Proceso</label>
    <select id="tipoProceso">
      <option value="">Selecciona uno...</option>
      <option>Contratación Directa</option>
      <option>Selección Abreviada</option>
      <option>Licitación Pública</option>
      <option>Concurso de Méritos</option>
    </select>
    <button onclick="mostrarBusqueda()">Siguiente</button>
  </div>

  <div id="formularioBusqueda" class="oculto">
    <h2>Consulta oportunidades en SECOP</h2>
    <label for="codigo">Código UNSPSC</label>
    <input type="text" id="codigo" placeholder="Ej. 80141600">

    <label for="estado">Estado del contrato</label>
    <select id="estado">
      <option value="">Todos</option>
      <option>Activo</option>
      <option>Terminado</option>
      <option>Liquidado</option>
      <option>Borrador</option>
    </select>

    <button onclick="buscarContratos()">Buscar</button>
    <div class="resultados" id="resultados"></div>
  </div>
</main>

<script>
  const FECHA_LIMITE = new Date('2024-06-06');

  function continuarFormulario() {
    const nombre = document.getElementById("nombre").value.trim();
    const correo = document.getElementById("correo").value.trim();
    const aceptado = document.getElementById("aceptaTerminos").checked;

    if (!nombre || !correo || !aceptado) {
      alert("Por favor, completa los datos obligatorios y acepta los términos.");
      return;
    }
    document.getElementById("formularioCliente").classList.add("oculto");
    document.getElementById("formularioProceso").classList.remove("oculto");
  }

  function mostrarBusqueda() {
    const proceso = document.getElementById("tipoProceso").value;
    if (!proceso) {
      alert("Selecciona un tipo de proceso.");
      return;
    }
    document.getElementById("formularioProceso").classList.add("oculto");
    document.getElementById("formularioBusqueda").classList.remove("oculto");
  }

  async function buscarContratos() {
    const codigo = document.getElementById("codigo").value.trim();
    const estado = document.getElementById("estado").value.trim();
    const resultadosDiv = document.getElementById("resultados");

    resultadosDiv.innerHTML = "Buscando...";

    if (!codigo) {
      resultadosDiv.innerHTML = "Por favor, ingresa un código UNSPSC válido.";
      return;
    }

    try {
      const url = `https://cors-anywhere.herokuapp.com/https://www.datos.gov.co/resource/jbjy-vk9h.json?$q=${codigo}`;
      const response = await fetch(url);
      const data = await response.json();

      const resultadosFiltrados = data.filter(proceso => {
        const cumpleEstado = !estado || proceso.estado_contrato === estado;
        const fechaPub = proceso.fecha_de_firma ? new Date(proceso.fecha_de_firma) : null;
        const cumpleFecha = fechaPub && fechaPub >= FECHA_LIMITE;
        return cumpleEstado && cumpleFecha;
      });

      if (resultadosFiltrados.length === 0) {
        resultadosDiv.innerHTML = `<p>No se encontraron resultados recientes para el código <strong>${codigo}</strong>.</p>`;
        return;
      }

      resultadosDiv.innerHTML = `<h3>Resultados recientes para código: ${codigo}</h3>`;
      resultadosFiltrados.forEach(proceso => {
        resultadosDiv.innerHTML += `
          <div class="contrato">
            <p><strong>Entidad:</strong> ${proceso.nombre_entidad || 'No disponible'}</p>
            <p><strong>Objeto del contrato:</strong> ${proceso.objeto_del_contrato || 'No disponible'}</p>
            <p><strong>Modalidad:</strong> ${proceso.modalidad_de_contratacion || 'No disponible'}</p>
            <p><strong>Valor:</strong> ${proceso.valor_del_contrato || 'No disponible'}</p>
            <p><strong>Estado:</strong> ${proceso.estado_contrato || 'No disponible'}</p>
            ${proceso.urlproceso?.url ? `<a href="${proceso.urlproceso.url}" target="_blank">Ver proceso en SECOP</a>` : ''}
          </div>
        `;
      });

    } catch (error) {
      resultadosDiv.innerHTML = `❌ Ocurrió un error al consultar la información. <br> 
        Asegúrate de haber habilitado el proxy desde 
        <a href='https://cors-anywhere.herokuapp.com/corsdemo' target='_blank'>cors-anywhere.herokuapp.com/corsdemo</a>.`;
    }
  }
</script>

</body>
</html>
